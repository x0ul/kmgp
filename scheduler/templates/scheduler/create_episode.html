{% extends 'base.html' %}

{% block header %}
<div class="flex text-gray-800 text-4xl">{% block title %}Creating a New Episode of <div class="pl-2 font-medium italic text-indigo-700">{{ show['title'] }}</div> {% endblock %}</div>
{% endblock %}

{% block content %}
<div class="text-gray-800">
  <form class="rounded px-8 pt-6 pb-8 mb-4" id="new_episode_form">
    <label class="block font-bold text-lg mb-2" for="title">Episode Title</label>
    <input class="block w-full border-2 px-2 py-2 mb-4" name="title" id="title" value="{{ request.form['title'] }}" required>
    <label class="block font-bold text-lg mb-2" for="air_date">Air Date</label>
    <div class="flex">
      <input class="block w-full border-2 px-2 py-2 mb-4" type="date" name="air_date" id="air_date" value="{{ request.form['air_date'] }}" required>
      <select id="hour" name="hour">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option>10</option>
        <option>11</option>
        <option selected>12</option>
      </select>
      <select id="ampm" name="ampm">
        <option>AM</option>
        <option selected>PM</option>
      </select>
    </div>
    <label class="block font-bold text-lg mb-2" for="audio_file">Episode Audio File</label>
    <input class="block w-full border-2 px-2 py-2 mb-4" type="file" id="audio_file" name="audio_file" accept="audio/*" required>
    <label class="block font-bold text-lg mb-2" for="description">Description</label>
    <textarea class="block w-full border-2 px-2 py-2 mb-4" name="description" id="description">{{ request.form['description'] }}</textarea>
    <input class="w-full font-bold text-lg border-2 rounded px-2 py-2" type="button" value="Save" onclick="upload()">
  </form>

  <div id="loading_indicator" style="display: none;">
    Loading...
  </div>

  <script>
    async function sha1(data) {
        const hashBuffer = await crypto.subtle.digest('SHA-1', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer))
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
        return hashHex
    }

    async function upload() {
        const token = "{{ upload['authorizationToken'] }}"
        const url = "{{ upload['uploadUrl'] }}"

        const audio_file = document.getElementById('audio_file').files[0]
        const audio_buf = await audio_file.arrayBuffer()
        const audio_file_sha1 = await sha1(audio_buf)

        try {
            document.querySelector("#loading_indicator").style.display = "block"
            const response = await fetch(url, {
                method: 'POST',
                body: audio_file,
                headers: {
                    'Authorization': token,
                    'X-Bz-File-Name': audio_file_sha1,
                    'Content-Type': audio_file.type,
                    'X-Bz-Content-Sha1': audio_file_sha1,
                    'X-Bz-Info-original-filename': encodeURIComponent(audio_file.name),
                    'X-Bz-Info-show-title': encodeURIComponent("{{ show['title'] }}"),
                    'X-Bz-Info-episode-title': encodeURIComponent(document.getElementById('title').value),
                    'X-Bz-Info-air-date': encodeURIComponent(document.getElementById('air_date').value),
                    'X-Bz-Info-uploader-uid': {{ g.user['id'] }}
                },
            })
            const json = await response.json();

            console.log('Success:', json)
            console.log('POSTing form...')


            // TODO fix 24 hour time
            let hour = Number(document.getElementById('hour').value)
            let hour_24 = (hour + document.getElementById('ampm').value === "PM" ? 12 : 0) % 24
            let air_date = document.getElementById('air_date').value + "T" + hour_24 + ":00"

            const form_response = await fetch(window.location.href.split('?')[0], {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'title': document.getElementById('title').value,
                    'air_date': air_date,
                    'audio_file': 'fake url for now',
                    'description': document.getElementById('description').value,
                })
            })

        } catch(err) {
            console.log(`shit's fucked: ${err}`)
        }

        location.href = "{{ url_for('scheduler.index') }}"
    }
  </script>
  {% endblock %}
</div>
